<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title></title>
    <link rel="stylesheet" type="text/css" href="https://miro.com/app/static/styles.1.0.css" />
    <link rel="stylesheet" type="text/css" href="styles.css" />
    <script type="text/javascript" src="https://miro.com/app/static/sdk.1.1.js"></script>
    <script type="text/javascript" src="config.js"></script>
    <script type="text/javascript" src="bottompanel.js"></script>
</head>

<body>
    <div class="bottompanel-container">
        <div class="bottompanel-content">
            <div class="bottompanel-section">
                <div class="bottompanel-input-row">
                    <span class="miro-h4">Estimate</span>
                    <div id="estimate-group" class="miro-input-group miro-input-group--small">
                        <button class="miro-btn miro-btn--secondary icon-minus js-estimate-plus-minus"
                            value="-1"></button>
                        <input type="text" class="bottompanel-input-number miro-input miro-input--primary js-estimate">
                        <button class="miro-btn miro-btn--secondary icon-plus js-estimate-plus-minus"
                            value="1"></button>
                    </div>
                </div>
                <div class="bottompanel-input-row">
                    <div class="miro-h4">Log Time</div>
                    <div id="logtime-group" class="miro-input-group miro-input-group--small">
                        <button class="miro-btn miro-btn--secondary icon-minus js-log-plus-minus" value="-1"></button>
                        <input type="text" class="bottompanel-input-number miro-input miro-input--primary js-log">
                        <button class="miro-btn miro-btn--secondary icon-plus js-log-plus-minus" value="1"></button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script type="text/javascript">

        // Catch references to elements
        let estimateInputElement = document.querySelector('.js-estimate');
        let estimateSaveButton = document.querySelector('.js-save-estimate');
        let estimateClearButton = document.querySelector('.js-clear-estimate');
        let estimatePlusMinusElements = document.querySelectorAll('.js-estimate-plus-minus');

        let logInputElement = document.querySelector('.js-log');
        let logPlusMinusElements = document.querySelectorAll('.js-log-plus-minus');

        // Place to cache info about current modal
        let modalInfo = {};

        // Wait for Miro to be ready
        miro.onReady(async () => {

            // Cache these values, they won't change during the runtime
            modalInfo = {
                widgets: await miro.board.selection.get(),
                userId: await miro.currentUser.getId()
            };

            registerListeners();
        });

        // Registers listeners to clicks, enters etc.
        function registerListeners() {

            estimatePlusMinusElements.forEach(element => {
                element.addEventListener('click', (event) => {
                    let val = changeInputValue(estimateInputElement, event.target.value);
                    updateEstimates(val)
                });
            });

            logPlusMinusElements.forEach(element => {
                element.addEventListener('click', (event) => { changeInputValue(logInputElement, event.target.value) });
            });
        }

        // Update the estimates for the widget
        async function updateEstimates(value) {
            let widgetsToUpdate = [];

            modalInfo.widgets.forEach((widget) => {

                let metadata = widget.metadata;

                // If our app didn't write any estimate for this widget before, we
                // need to create the whole structure anew
                if (metadata[Config.app_id] === undefined) {
                    metadata = { [Config.app_id]: { "estimate": value } };
                } else {
                    // We already have the structure ready, let's just write new value
                    metadata[Config.app_id].estimate = value;
                }

                widgetsToUpdate.push({
                    id: widget.id,
                    card: {
                        customFields: [{
                            value: `${metadata[Config.app_id].logged} / ${metadata[Config.app_id].estimate}`,
                            iconUrl: "https://cdn2.iconfinder.com/data/icons/dark-action-bar-2/96/select_all-512.png"
                        }]
                    },
                    metadata: metadata
                });
            });

            // Store new metadata in bulk
            if (widgetsToUpdate.length > 0) {
                await miro.board.widgets.update(widgetsToUpdate);
            }
        }
    </script>
</body>

</html>